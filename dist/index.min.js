!function(){var e,t;(e=function(e){return this._quill=(e=null==e?{}:e).editor,this._sig={},this._evthdr={},this._upload=e.upload,this._progress=e.progress||function(){},this.handler={upload:this._handler.upload.bind(this),change:this._handler.change.bind(this)},this}).prototype=((t=Object.create(Object.prototype)).on=function(e,i){var n=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=n._evthdr)[e]||(t[e]=[])).push(i)})},t.fire=function(e){for(var t,i,n,r,l=[],s=[],o=1,u=arguments.length;o<u;++o)s.push(arguments[o]);for(t=s,o=0,n=(i=this._evthdr[e]||[]).length;o<n;++o)r=i[o],l.push(r.apply(this,t));return l},t.editor=function(e){return arguments.length?this._quill=e:this._quill},t.needUpload=function(e){return!(!/data:image/.exec(e=null==e?"":e)||this._sig[this.sig(e)])},t.sig=function(e){return(e||"").substring(0,64)},t.key=function(){return Math.random().toString(36).substring(2)+"-"+Date.now()},t.insert=function(t){var i=this,e=this._quill.getContents();if(e.ops.filter(function(e){return t.sig===i.sig((e.insert||{}).image)?(e.insert.image=t.file.url,!0):"#"+t.sig===i.sig((e.attributes||{}).link)&&(e.attributes.link=t.file.url,e.insert=t.file.url,!0)}).length)return this._quill.setContents(e)},t._ld='xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="96" height="96" style="background:#fafafa"><g><circle stroke-dasharray="131.95 45.98" r="28" stroke-width="8" stroke="#d7d7d7" fill="none" cy="50" cx="50"><animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform></circle></g></svg>',t.uploadFiles=function(e,t){return this._uploadFiles(e=null==e?[]:e,t,0)},t._uploadFiles=function(t,i,n,r){var l,s=this;return null==r&&(r={}),(l=t[n])?Promise.resolve().then(function(){return s._upload({file:l.blob,progress:s._progress})}).then(function(e){var t;return e=[((t=((e,t)=>{var i,n={}.hasOwnProperty;for(i in t)n.call(t,i)&&(e[i]=t[i]);return e})({},e)).blob=l.blob,t)],r.detail?r.detail(e):Promise.resolve(e)}).then(function(e){return delete(e=e[0]).blob,s.fire("uploaded",e),i&&i((l.file=e,l)),s._uploadFiles(t,i,n+1,r)}):Promise.resolve()},t.convertImages=function(e){e=e.map(function(t){return ldfile.fromURL(t.image,"blob").then(function(e){return{blob:e.file,sig:t.sig}})});return Promise.all(e)},t._handler={upload:function(l){var s=this;return null==l&&(l={}),function(){var r=document.createElement("input");return r.setAttribute("type","file"),"image"===l.type&&r.setAttribute("accept","image/png, image/gif, image/jpeg"),r.onchange=function(){var e,t,i,n=r.files;if(n&&n.length)return n=[n[0]],r.value=null,e=s.key(),"image"===l.type?(t="data:image/svg+xml;base64,"+btoa('<svg data-key="'+e+'" '+s._ld),i=s.sig(t),s._sig[i]=!0,s._quill.insertEmbed(s._quill.getSelection().index,"image",t)):(i=s.sig(e),s._sig[i]=!0,s._quill.insertText(s._quill.getSelection().index,i,{link:"#"+i})),s.uploadFiles(n.map(function(e){return{blob:e,sig:i}}),s.insert.bind(s))},r.click()}},change:function(i,e,t){var r=this;return Promise.resolve().then(function(){var e,n={},t=i.ops.filter(function(e){return r.needUpload((e.insert||{}).image)}).map(function(e){var t=r.key(),e=e.insert.image,t="data:image/svg+xml;base64,"+btoa('<svg data-key="'+t+'" '+r._ld),i=r.sig(t);return r._sig[i]=!0,n[e]={sig:i,image:e,placeholder:t}});if(t.length)return(e=r._quill.getContents()).ops.map(function(e){var t;if(t=n[(e.insert||{}).image])return e.insert.image=t.placeholder}),debounce(0).then(function(){return r._quill.setContents(e,"silent"),r.convertImages(t).then(function(e){return r.uploadFiles(e,r.insert.bind(r))})})})}},t),"undefined"!=typeof module&&null!==module?module.exports=e:window&&(window.quillUploader=e)}.call(this);
